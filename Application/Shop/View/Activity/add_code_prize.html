<!DOCTYPE html>
<include file="index/head" />
  <!-- END HEADER -->

  <!-- BEGIN CONTAINER -->
  <link href="__PUBLIC__/city/zyzn_1.css" type="text/css" rel="stylesheet">
  <div class="page-container row-fluid">

    <!-- BEGIN SIDEBAR -->

     <include file="index/left" />

    <!-- END SIDEBAR -->

    <!-- BEGIN PAGE -->  

    <div class="page-content">

      <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->

      <div id="portlet-config" class="modal hide">

        <div class="modal-header">

          <button data-dismiss="modal" class="close" type="button"></button>

          <h3>portlet Settings</h3>

        </div>

        <div class="modal-body">

          <p>Here will be a configuration form</p>

        </div>

      </div>

      <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->

      <!-- BEGIN PAGE CONTAINER-->

      <div class="container-fluid">

        <!-- BEGIN PAGE HEADER-->   

        <div class="row-fluid">

          <div class="span12">

            <!-- BEGIN STYLE CUSTOMIZER -->

            
                     
            <!-- END BEGIN STYLE CUSTOMIZER -->   

            <h3 class="page-title">

              修改活动

            </h3>

            <ul class="breadcrumb">

              <li>

                <i class="icon-home"></i>

                <a href="index.html">活动管理</a> 

                <span class="icon-angle-right"></span>

              </li>

            <!--   <li>
            
              <a href="#">代理管理</a>
            
              <span class="icon-angle-right"></span>
            
            </li> -->

              <li><a href="#">修改活动</a></li>

            </ul>

          </div>

        </div>

        <!-- END PAGE HEADER-->

        <!-- BEGIN PAGE CONTENT-->

        <div class="row-fluid">

          <div class="span12">

            <!-- BEGIN SAMPLE FORM PORTLET-->   

            <div class="portlet box blue">

              <div class="portlet-title">

                <div class="caption"><i class="icon-reorder"></i>修改活动</div>

                <div class="tools">

                  <a href="javascript:;" class="collapse"></a>

                  <a href="#portlet-config" data-toggle="modal" class="config"></a>

                  <a href="javascript:;" class="reload"></a>

                  <a href="javascript:;" class="remove"></a>

                </div>

              </div>
           
              <div class="portlet-body form">

                <!-- BEGIN FORM-->

                <form action="#" class="form-horizontal" id="form">
               
                  

                  <div class="control-group">

                    <label class="control-label"><span style="color: red;">*</span>码段绑定</label>

                    <div class="controls maduan_num" id="code_list">

                    <button type="button" class="btn blue click_shop" onclick="fenpei_maduan()">分配码段</button> 
                     <div style="height: 44px; width:500px; border:1px dashed #CFCFCF; text-align:left; padding-left: 10px; line-height: 44px; font-size: 15px; display: none;" id="total_box">总计码量：<span id="total_code"></span> 个</div>
                     <volist name="code_num" id="vo">
                     <div class="c" style="height: 44px; width:500px; border:1px dashed #CFCFCF; text-align:left; padding-left: 10px; line-height: 44px; font-size: 15px; color:blue;" >号段：{$vo.code_number}&nbsp;&nbsp;数量：{$vo.id|code_num} 个 <input type='hidden' name='' value='{$vo.id}'></div>
                     </volist>

                    </div>
                      
                   </div>
                  <script>
                  </script>
                   
                  <div class="control-group">

                    <label class="control-label"><span style="color: red;">*</span>活动奖励设置</label>

                    <div class="controls">

                      <div class="control-group sizz" style=" width:700px;">
                    <!--   <if condition="$find[type] neq 2">   -->  <!--   </if>   --> 
                           <button type="button" class="btn yellow" id="siz"  class="" >添加奖励</button>
                     
                      <volist name="prize_list" id="vo"> 
                        <div class="d" style="margin-top:5px;margin-bottom:5px;margin-left:5px; pandding:0px; ">
                         <span>奖励类型：</span>
                         <select class="span6 m-wrap money_type" onchange="changes(this)" data-placeholder="Choose a Category" tabindex="1" style="width:150px;" name=""  readonly>
                         <option value="1" <if condition="$vo[prize_type] eq 1">checked</if>>--现金红包--</option>
                         <option value="2" <if condition="$vo[prize_type] eq 2">checked</if>>--随机红包--</option>
                         <option value="3" <if condition="$vo[prize_type] eq 3">checked</if>>--兑换券--</option>
                         <option value="4" <if condition="$vo[prize_type] eq 4">checked</if>>--优惠券--</option>
                         </select> 
                         <if condition="$vo[prize_type] eq 1">
                           <div style="display: inline-block" class="a_nei">
                           <span style="margin-left:10px;" class="wenzi">奖励内容</span>
                           <input type="text"  style="width:100px; margin-left:5px;" placeholder="0.3" value="{$vo.prize}" readonly/> 元
                           </div>
                         </if>
                         <if condition="$vo[prize_type] eq 2">
                           <div style="display: inline-block" class="a_nei">
                           <span style="margin-left:10px;" class="wenzi">总金额</span>
                           <input type="text"  style="width:100px; margin-left:5px;" placeholder="0.3" value="{$vo.prize}" readonly/> 元
                           </div>
                         </if>
                         <if condition="$vo[prize_type] eq 3">
                           <div style="display: inline-block" class="a_nei">
                           <span>兑换券：</span>
                           <select class="span6 m-wrap" data-placeholder="Choose a Category" tabindex="1" style="width:110px;"  readonly>
                             <volist name="dui_list" id="vo2"> 
                              <option value="{$vo2.id}" <if condition="$vo2[id] eq $vo[prize]">checked</if> >--{$vo2.name}--</option>   
                             </volist>
                           </select>
                           </div>
                         </if>
                         <if condition="$vo[prize_type] eq 4">
                            <div style="display: inline-block" class="a_nei">
                           <span>优惠券：</span>
                           <select class="span6 m-wrap " data-placeholder="Choose a Category" tabindex="1" style="width:110px;"  readonly>
                             <volist name="you_list" id="vo3"> 
                              <option value="{$vo3.id}" <if condition="$vo3[id] eq $vo[prize]">checked</if> >--{$vo3.name}--</option>   
                             </volist>
                           </select>
                           </div>
                         </if>
                         

                          <span style="margin-left:10px;">数量</span>
                          <input type="number" min="1"  style="width:50px; margin-left:5px;" value="{$vo.prize_amount}" readonly/>
                        </div>
                    </volist>
                      <div class="e" style="margin-top:5px; margin-bottom:5px; margin-left:5px; background-color: #eee; width: 695px; height: 34px; line-height:34px; text-align: center;">
                       <!--  活动总金额：￥<span style="color:red;">1.5</span>元，活动总奖励数：<span style="color:red;">2</span>个，红包：<span style="color:red;">2</span>个，兑换券：<span style="color:red;">0</span>个，优惠券：<span style="color:red;">0</span>个 -->
                      </div>
                    </div>
                    
                     

                    </div>

                  </div>

                  <script>
                  
                    $('#siz').click(function(){
                      //var a = $('.ad').index(this);
                      var size = "<div class=\"d\" style=\"margin-top:5px;margin-bottom:5px;margin-left:5px; pandding:0px;  \"><span>奖励类型：</span><select class=\"span6 m-wrap money_type\" onchange=\"changes(this)\" data-placeholder=\"Choose a Category\" tabindex=\"1\" style=\"width:150px;\" name=\"money_type[]\" ><option value=\"1\">--现金红包--</option><option value=\"2\">--随机红包--</option><option value=\"3\">--兑换券--</option><option value=\"4\">--优惠券--</option></select> <div style=\"display: inline-block\" class=\"a_nei\"><span style=\"margin-left:10px;\" class=\"wenzi\">奖励内容</span><input type=\"text\" name=\"money[]\" style=\"width:100px; margin-left:5px;\" placeholder=\"0.3\"/> 元</div><span style=\"margin-left:10px;\">数量</span><input type=\"number\" min=\"1\" value=\"1\" name=\"amount[]\" style=\"width:50px; margin-left:5px;\"/><a href='javascript:void(0);' class=\"delfj\" style=\"height:30px; line-height:30px; margin-left:10px;\" onclick=\"dele()\">删除</a></div>";
                        $(".sizz").append(size);
                        $(".sizz").css('border','1px dashed #CFCFCF');

                     });
                     function changes(aa){
                       var a = $('.money_type').index(aa);
                      // alert(a);
                       var zhi = $('.money_type').eq(a).val();
                       if(zhi==1){
                         var zz = "<span style=\"margin-left:10px;\" class=\"wenzi\">奖励内容</span><input type=\"text\" name=\"money[]\" style=\"width:100px; margin-left:5px;\" placeholder=\"0.3\"/> 元";
                         $('.a_nei').eq(a).html("");
                         $('.a_nei').eq(a).append(zz);
                       }
                       if(zhi==2){
                         var zz = "<span style=\"margin-left:10px;\" class=\"wenzi\">总金额</span><input type=\"text\" name=\"money[]\" style=\"width:100px; margin-left:5px;\" placeholder=\"0.3\"/> 元";
                         $('.a_nei').eq(a).html("");
                         $('.a_nei').eq(a).append(zz);
                       }
                      if(zhi==3){
                          var url = '__CONTROLLER__/choose_quan';
                          var data = {'type':1};
                          $.post(url,data,function(res){
                              if (res.status == 1) {
                                var ss = '';
                                ss +="<span>兑换券：</span><select class=\"span6 m-wrap \" data-placeholder=\"Choose a Category\" tabindex=\"1\" style=\"width:110px;\" name=\"money[]\" >";
                                for (var i = 0; i < res.datas.length; i++) {
                                ss += "<option value=\""+res.datas[i].id+"\">--"+res.datas[i].name+"--</option>";
                               }
                                ss+="</select>";
                                $('.a_nei').eq(a).html("");
                                $('.a_nei').eq(a).append(ss);
                             } 

                           },'JSON');
                       
                      }
                       if(zhi==4){
                          var url = '__CONTROLLER__/choose_quan';
                          var data = {'type':2};
                          $.post(url,data,function(res){
                              if (res.status == 1) {
                                var ss = '';
                                ss +="<span>优惠券：</span><select class=\"span6 m-wrap \" data-placeholder=\"Choose a Category\" tabindex=\"1\" style=\"width:110px;\" name=\"money[]\" >";
                                for (var i = 0; i < res.datas.length; i++) {
                                ss += "<option value=\""+res.datas[i].id+"\">--"+res.datas[i].name+"--</option>";
                               }
                                ss+="</select>";
                                $('.a_nei').eq(a).html("");
                                $('.a_nei').eq(a).append(ss);
                             } 

                           },'JSON');
                       
                      }
                      

                     };
 
                      function dele(){
                            var a = $('.delfj').index(this);
                            $(".d").eq(a).remove();
                        }

                  </script>
                   <input type="hidden" name="activity_post_id" value="{$find.id}">
                    <div class="form-actions" style="">
                      <button type="button" class="btn blue"  onclick="submit_form()">确认追加</button>
                      <a href="__CONTROLLER__/index"><button type="button" class="btn">返回</button></a>
                </div>
    
        
         

      

                  
                 </div>

                 <input type="hidden" name="activity_id" value="{$find.id}">
                </form>
                
                <!-- END FORM-->

              </div>

            </div>

            <!-- END EXTRAS PORTLET-->

          </div>

        </div>
      <input type="hidden" id="type_id" value="{$typeid}">
        <!-- END PAGE CONTENT-->         
   


       
      </div>
      
      <div id="rjbbbb"></div>
      <!-- END PAGE CONTAINER-->

    </div>

    <!-- END PAGE -->  

  </div>
  <!-- END CONTAINER -->
   <script>

   jQuery(document).ready(function() {       

       // initiate layout and plugins

       App.init();

       FormComponents.init();

    });
    function submit_form(){
           
          var data=$('#form').serialize();  
          var url = '__CONTROLLER__/code_prize_save';
          var jump_url = '__CONTROLLER__/index';
          $.post(url,data,function(res){
              if (res.status == 1) {
                  dialog.success(res.message,jump_url);
                    //window.location.href=jump_url;
                  } 
               if(res.status == 0){
                  dialog.error(res.message);
                 }

           },'JSON');
    }



   $('.imgfiles').change(function(){
                var a=$('.imgfiles').index(this);
                var imgUrlId='.imgfiles:eq('+a+')';
                var nameId='.imgurl:eq('+a+')';
                var imgpic='.imgpic:eq('+a+')';
                //alert(imgpic);
                var hid='.hidd:eq('+a+')';
                uploadimg(imgUrlId,nameId,imgpic,hid);
            })
//厂家图片上传
            function uploadimg(imgUrlId,nameid,imgpic,hid){  
                 var formData = new FormData();  //实例化上传方法
                 formData.append('file', $(imgUrlId)[0].files[0]); //file相当于 name值

                 var size = $(imgUrlId)[0].files[0].size;
                 var Max_Size=1024*1024;
                 if (size>Max_Size){dialog.error('图片大小不能大于一兆');return false; };

                $.ajax({
                    url: "__CONTROLLER__/upload",
                    type: 'POST',
                    cache: false,
                    data: formData,
                    dataType: 'text',
                    processData: false,
                    contentType: false,
                    success: function (data) {
                      $(nameid).val(data);
                      $('.imgpic').attr("src",data);
                      $(hid).css("display",'block');
                    }
                })
              }; 
    
  </script>


<div class="modal" id="fenpei_box" style="display: none;" >
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
<!-- ======= -->

         <form class="form-horizontal" id="form_code" action="__CONTROLLER__/add" method="post" enctype="multipart/form-data" >
          <table class="table table-striped table-hover table-bordered" id="sample_editable_1">

                  <thead>
                      <tr>
                      <th colspan="10" style="text-align: center;">分配码段</th>
                      </tr>
                    <tr>
                      <th></th>
                      <th style="text-align: center;">ID</th>
                      <th style="text-align: center;">批号</th>
                      <th style="text-align: center;">码段</th>
                      <th style="text-align: center;">数量</th>
                      <th style="text-align: center;">拆分</th>
                    </tr>

                  </thead>
                                   
                  <tbody class="tbody">
                   <?php if(!empty($code_list)){ ?>
                      <volist name="code_list" id="vo">
                     
                      <tr class="">
                        <td style="width:20px;">
                          <input type="checkbox" name="code_num_id[]" value="{$vo.id}">
                        </td>
                        <td style="text-align: center;">{$vo.id}</td>
                        <td style="text-align: center;">{$vo.pici}</td>
                        <td style="text-align: center; color: blue;">{$vo.code_number}</td>
                        <td style="text-align: center;">{$vo.id|code_num}</td>
                        <td style="text-align: center;"> 
                         <button type="button" class="btn green mini" attr-id="{$vo.id}" data-toggle="modal" href="#chaifen{$vo.id}">拆分</button>
                        </td>    
                                                            
                      </tr>
                     </volist>
                       <?php }else{ ?>
                       <tr>
                          <td style="text-align: center;" colspan="10">暂无未分配码段，快去联系代理商吧！</td>
                       </tr>
                      <?php  }  ?>
                    <tr>
                     
                     <td colspan="10" style="text-align: center;">
                       <input type="hidden" id="click_shop_id" name="click_shop_id">
                       <button class="btn blue" id="click_fenpei" type="button" onclick="fenpei_code()">确认分配</button>
                       <button class="btn white" id="click_off" type="button" onclick="click_offs()">关闭窗口</button>
                      </td>
                    </tr>
                  </tbody>

                </table>
                <div class="pagination" style="float:right;">
                  <ul><li>{$code_page}</li></ul>
                </div>
        </form>
<!-- ============ -->
        
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade in" id="top_ceng" style="display: none;"></div>
<script>
  function click_offs(){
    $('#fenpei_box').css('display','none');
    $('#top_ceng').css('display','none');
  }
  function fenpei_maduan(){
    $('#fenpei_box').css('display','block');
    $('#top_ceng').css('display','block');

  }

 function fenpei_code(){

   var data = $('#form_code').serialize();
   var url = '__CONTROLLER__/return_code';
    $.post(url,data,function(res){
     // console.log(res.datas);
        if(res.status==1){
           $('#fenpei_box').css('display','none');
           $('#top_ceng').css('display','none');
          var zz="";
          for (var i = 0; i < res.datas.length; i++) {
              zz += "<div class=\"c\" style=\"height: 44px; width:500px; border:1px dashed #CFCFCF; text-align:left; padding-left: 10px; line-height: 44px; font-size: 15px;\" >号段：  "+res.datas[i].maduan+"&nbsp;&nbsp;数量："+res.datas[i].num+" 个 <a href='javascript:void(0);' class=\"del_cod\" style=\"height:30px; line-height:30px; margin-left:10px; color:red;\" onclick=\"dele_code()\">删除</a><input type='hidden' name='choose_code_id[]' value='"+res.datas[i].id+"'></div>";
          }
           $('#code_list').append(zz);
           $('#total_box').css('display','block');
           $('#total_code').html(res.shuju);
          
        }else{
           dialog.error(res.message);
        }

     },'JSON');

  };
            function dele_code(){
                  var a = $('.del_cod').index(this);
                  $(".c").eq(a).remove();
              }

</script>

<volist name="code_list" id="vo">  
<div class="modal fade off_box" id="chaifen{$vo.id}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
<!-- ======= -->

         <form class="form-horizontal" id="form" action="" method="post" enctype="multipart/form-data">
           <table width="400" border="0" cellpadding="0" cellspacing="1" bgcolor="#a8c7ce" class="table">
                <tr>
                   <td colspan="2" style="border:1px #ccc solid; line-height:30px; background-color:#eee; text-align: center;" height="20" width="200" align=""><b>拆分码段</b></td>
                 </tr>
                 <tr>
                    <td style="border:1px #ccc solid; line-height:30px;" height="20" width="100" align="center">码段</td>
                    <td style="border:1px #ccc solid;" height="20" width="200" align="center">
                       {$vo.code_number}
                    </td>
                 </tr>
                  <tr>
                    <td style="border:1px #ccc solid; line-height:30px;" height="20" width="100" align="center">提示</td>
                    <td style="border:1px #ccc solid;" height="20" width="200" align="center">
                       您最多拆成{$vo.id|code_num}组
                    </td>
                 </tr>
                   <tr>
                    <td style="border:1px #ccc solid; line-height:30px;" height="20" width="100" align="center">拆分数量</td>
                    <td style="border:1px #ccc solid;" height="20" width="200" align="center">
                       <input type="text" class="form-control input-sm chai" id="chai" name="chai" style="width:200px; height:30px;"  />
                    </td>
                 </tr>
                  
                  <tr>
                    <td style="border:1px #ccc solid; line-height:30px; text-align: center;" height="20" width="100" align="center" colspan="2">
                    <input type="hidden" class="chaifen_id" value="{$vo.id}">
                    <button class="btn blue kai" type="button" attr-id="{$vo.id}">确认拆分</button>
                    </td>
                 </tr>
                
          </table>
        </form>
<!-- ============ -->
        
      </div>
    </div>
  </div>
</div>
</volist>
<div class="modal-backdrop fade in" id="top_ceng" style="display: none;"></div>

<script type="text/javascript">
  function click_chai_code(){
    $('#fenpei_box').css('display','none');
    $('#top_ceng').css('display','none');
  }
  function fenpei_maduan(){
    $('#fenpei_box').css('display','block');
    $('#top_ceng').css('display','block');

  }
  $('.kai').click(function(){
    $('.off_box').modal('hide');
    var a = $('.kai').index(this);
    var id = $('.kai').eq(a).attr('attr-id');
   // alert(id);
    var chai_num = $('.chai').eq(a).val();
   // alert(chai_num);
    var url = '__CONTROLLER__/chaifen';
    var jump_url = '__CONTROLLER__/add';
    var data = {'id':id,'chai_num':chai_num};
    $.post(url,data,function(res){
        if (res.status == 1) {
              var new_code = '';
              new_code += '<tr>';
              new_code += '<td style=\"width:20px;\">';
              new_code += '<input type=\"checkbox\" name=\"code_num_id[]\" value=\"'+res.datas.id+'\">';
              new_code += '</td>';
              new_code += ' <td style=\"text-align: center;\">'+res.datas.id+'</td>';
              new_code += '<td style=\"text-align: center;\">'+res.datas.pici+'</td>';
              new_code += '<td style=\"text-align: center; color: blue;\">'+res.datas.code_number+'</td>';
              new_code += '<td style=\"text-align: center;\">'+res.datas.count+'</td>';
              new_code += '<td style=\"text-align: center;\"> ';
              new_code += '<button type=\"button\" class=\"btn green mini\" attr-id=\"'+res.datas.id+'\" data-toggle=\"modal\" href=\"#chaifen'+res.datas.id+'\">拆分</button>';
              new_code += '</td>';
              new_code += '</tr>';
             $('.tbody').prepend(new_code);
             $('.off_box').modal('hide');
            } 
         if(res.status == 0){
            dialog.error(res.message);
        }

     },'JSON');
  });


</script>
  <!-- BEGIN FOOTER -->                                       
                      
<include file="index/footer" />
 

  <!-- END FOOTER -->

  <!-- BEGIN JAVASCRIPTS(Load javascripts at bottom, this will reduce page load time) -->

  <!-- BEGIN CORE PLUGINS -->
  <script src="__PUBLIC__/media/js/jquery-1.10.1.min.js" type="text/javascript"></script>

  <script src="__PUBLIC__/media/js/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>

  <!-- IMPORTANT! Load jquery-ui-1.10.1.custom.min.js before bootstrap.min.js to fix bootstrap tooltip conflict with jquery ui tooltip -->

  <script src="__PUBLIC__/media/js/jquery-ui-1.10.1.custom.min.js" type="text/javascript"></script>      

  <script src="__PUBLIC__/media/js/bootstrap.min.js" type="text/javascript"></script>

  <!--[if lt IE 9]>

  <script src="__PUBLIC__/media/js/excanvas.min.js"></script>

  <script src="__PUBLIC__/media/js/respond.min.js"></script>  

  <![endif]-->   

  <script src="__PUBLIC__/media/js/jquery.slimscroll.min.js" type="text/javascript"></script>

  <script src="__PUBLIC__/media/js/jquery.blockui.min.js" type="text/javascript"></script>  

  <script src="__PUBLIC__/media/js/jquery.cookie.min.js" type="text/javascript"></script>

  <script src="__PUBLIC__/media/js/jquery.uniform.min.js" type="text/javascript" ></script>

  <!-- END CORE PLUGINS -->

  <!-- BEGIN PAGE LEVEL PLUGINS -->

  <script type="text/javascript" src="__PUBLIC__/media/js/select2.min.js"></script>

  

  <script type="text/javascript" src="__PUBLIC__/media/js/DT_bootstrap.js"></script>

  <!-- END PAGE LEVEL PLUGINS -->

  <!-- BEGIN PAGE LEVEL SCRIPTS -->

  <script src="__PUBLIC__/media/js/app.js"></script>

  <script src="__PUBLIC__/media/js/table-editable.js"></script>    


  <!-- END PAGE LEVEL SCRIPTS -->

 

  <!-- END JAVASCRIPTS -->   

</body>

<!-- END BODY -->

</html>